<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="google" content="notranslate" />
   	<meta http-equiv="X-UA-Compatible" content="IE=edge">
   	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PHP8の覚書 | ワクガンス</title>
	<link rel='shortcut icon' href='/home/images/favicon.ico' />
	
	<link href="/note_prg/css/bootstrap.min.css" rel="stylesheet">
	<link href="/note_prg/css/highlight/default.css" rel="stylesheet">
	<link href="/note_prg/css/common2.css" rel="stylesheet">
	<script src="/note_prg/js/jquery-3.5.1.min.js"></script>	
	<script src="/note_prg/js/bootstrap.min.js"></script>
	<script src="/note_prg/js/highlight.pack.js"></script>
	<script src="/note_prg/js/livipage.js"></script>
	<script src="/note_prg/js/ImgCompactK.js"></script>

	<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<div id="header" ><h1>PHP8の覚書 | ワクガンス</h1></div>
<div class="container">


<div id="sec22-1" class="sec4" >
    <h3>iniファイル内のデータを読み込み、配列にセットする</h3>
    
iniファイルからデータを読み込んで配列にセットするPHPコードは以下のようになります。


<pre>$config = parse_ini_file("config.ini");</pre>
上記のコードでは、parse_ini_file() 関数を使用して、指定された config.ini ファイルからデータを読み込みます。読み込んだデータは、連想配列として $config 変数に格納されます。<br>
<br>
config.ini ファイルの例を以下に示します。<br>
<pre>
[database]
host = localhost
username = root
password = secret
dbname = mydatabase

[server]
ip = 192.168.0.1
port = 8080
</pre>


上記の config.ini ファイルから、以下のような配列が生成されます。
<pre>
Array
(
    [database] => Array
        (
            [host] => localhost
            [username] => root
            [password] => secret
            [dbname] => mydatabase
        )

    [server] => Array
        (
            [ip] => 192.168.0.1
            [port] => 8080
        )
)
</pre>
上記のように、セクション名をキーとして、各キーに対応するセクション内のキーと値のペアが、2次元配列として格納されます。

    <br><time>2023-2-24</time>
</div>


<div id="sec22-2" class="sec4" >
    <h3>配列をiniファイルへ書き込む   </h3>

配列をiniファイルへ書き込むPHPコードは以下のようになります。

<pre><code>
$data = array(
    'database' => array(
        'host' => 'localhost',
        'username' => 'root',
        'password' => 'secret',
        'dbname' => 'mydatabase'
    ),
    'server' => array(
        'ip' => '192.168.0.1',
        'port' => '8080'
    )
);

$config = '';

foreach ($data as $key => $value) {
    $config .= "[$key]\n";
    foreach ($value as $k => $v) {
        $config .= "$k = $v\n";
    }
    $config .= "\n";
}

file_put_contents('config.ini', $config);
</code></pre>
上記のコードでは、配列 $data をループ処理して、iniファイルの文字列を生成します。生成された文字列は file_put_contents() 関数を使用して、config.ini ファイルに書き込まれます。<br>
<br>
生成される config.ini ファイルの内容は以下のようになります。<br>

<pre>
makefile
Copy code
[database]
host = localhost
username = root
password = secret
dbname = mydatabase

[server]
ip = 192.168.0.1
port = 8080
</pre>
上記のように、セクション名をキーとして、各キーに対応するセクション内のキーと値のペアが、iniファイルに書き込まれます。


    <br><time>2023-2-24</time>
</div>


<div id="sec22-3" class="sec4" >
	<h3>SQLサニタイズ【2023年版】</h3>
	
SQLインジェクション対策の歴史を辿ると、以前はaddslashes関数が主に使われていました。この関数はクエリ内の特殊文字をエスケープすることで、ある程度のSQLインジェクション攻撃を防ぐことが可能でした。
実際、私自身が開発したシステムに対してハッキングを試みた経験がありますが、全ての試みが失敗に終わったことからも、その効果は一定程度認められます。<br>
<br>

しかし、全ての攻撃を防ぐには至らず、未知の可能性に対する不安も残ります。
特に、特定の文字列を異なるエンコーディング間で変換すると、予期せぬバックスラッシュが出現する場合があります。
例えば、"表"という文字をUTF-8からShift-JISに変換すると、この現象が発生します。このバックスラッシュは新たなセキュリティ上のリスクを生む可能性があり、大きな懸念材料となっています。<br>
<br>

旧来の管理システムをよりセキュアなプリペアドステートメント方式へ書き換えるという対策もありますが、その修正コストは決して安価ではありません。
そのため、私はaddslashes関数を使わない新たなSQLサニタイズ方式を考案しました。しかし、SQLサニタイズ自体が時代遅れのアプローチであるとの認識もあり、この方式を使用するべきはやむを得ない理由がある場合だけとなります。<br>
<br>

2023年現在、最先端のSQLインジェクション対策としてはプリペアドステートメント方式が主流となっています。
この方式は、SQLのパラメータを一度に指定することで、インジェクション攻撃を防ぐことができます。そのため、既存のシステムの安全性を向上させるためには、可能な限りこのプリペアドステートメント方式を採用すべきであると強く推奨します。<br>
<br>
	
	
	<p>sqlSanitize自作関数</p>
	<pre><code>
	function sqlSanitize($text) {
		$text = trim($text);
		
		// 文字列がUTF-8でない場合、UTF-8に変換する
		if(!mb_check_encoding($text, 'UTF-8')){
			$text = str_replace(['&yen;&yen;', '/', '&yen;'', '"', '`',' OR '], '', $text);
			$text = mb_convert_encoding($text, 'UTF-8');
		}
			
		// SQLインジェクションのための特殊文字をエスケープする
		$search = array("&yen;&yen;", "&yen;x00", "&yen;n", "&yen;r", "'", '"', "&yen;x1a", "`");
		$replace = array("&yen;&yen;&yen;&yen;", "&yen;&yen;0", "&yen;&yen;n", "&yen;&yen;r", "&yen;&yen;'", "&yen;&yen;&yen;"", "&yen;&yen;Z", "");
		
		$text = str_replace($search, $replace, $text);
			
		return $text;
	}
	</code></pre>

	<a href="/sample/php/a080/sql_sanitaize/sqlSanitize.php" class="btn btn-info">検証</a><br>
	<br>

	<br><time>2023-2-24</time>
</div>


<div id="sec22-0" class="sec4" style="display:none">
	<h3>xxx</h3>


	<br><time>2023-2-24</time>
</div>


<div class="yohaku"></div>
<ol class="breadcrumb">
	<li><a href="/">ホーム</a></li>
	<li><a href="/note_prg">プログラミングの覚書</a></li>
	<li><a href="/note_prg/php/">PHPの覚書</a></li>
	<li>PHP8の覚書</li>
</ol>
</div><!-- content -->
<div id="footer">(C) kenji uehara 2023-2-24</div>
</body>
</html>