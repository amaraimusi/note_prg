<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="google" content="notranslate" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>決済代行サービスについて | ワクガンス</title>
	<link rel='shortcut icon' href='/home/images/favicon.ico' />
	
	<link href="/note_prg/css/bootstrap-4.3.1-dist/bootstrap.min.css" rel="stylesheet">
	<link href="/note_prg/css/bootstrap-4.3.1-dist/font/css/open-iconic.min.css" rel="stylesheet">
	<link href="/note_prg/css/highlight/default.css" rel="stylesheet">
	<link href="/note_prg/css/common2.css" rel="stylesheet">
	<script src="/note_prg/js/jquery3.js"></script>	<!-- jquery-3.3.1.min.js -->
	<script src="/note_prg/js/bootstrap-4.3.1-dist/bootstrap.bundle.min.js"></script>
	<script src="/note_prg/js/vue.min.js"></script>
	<script src="/note_prg/js/highlight.pack.js"></script>
	<script src="/note_prg/js/livipage.js"></script>
	<script src="/note_prg/js/ImgCompactK.js"></script>

	<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<div id="header" ><h1>決済代行サービスについて | ワクガンス</h1></div>
<div class="container" style="font-size:1.5em;line-height:1.4em;">


新しい案件依頼に決済機能がほしいとの要件があった。しかもサブスク。
自前で決済機能を用意するのは難しそう。
なので決済代行サービスを上手く利用したい。今のところ決済代行サービスについてはほとんど分かっていない。Wordpressでお手軽に実装できることは知っているが。<br>
難しければ案件を断ればいいし、気軽に決済サービスについて調べていこう。<br>
<br>

さっそく、「決済代行サービス API」で検索すると「Gateway(APIゲートウェイ)」という見知らぬ言葉が出てきた。<br>
"APIゲートウェイとは、APIの管理や実行を容易にするしくみ"とある。CURLとCORSなのだろうか？またはそれ以外の方法か？<br>
<br>

<p>APIゲートウェイとは</p>
例えばクライアントが決済サービス、メール通知、レコメンド機能の３つのAPIを利用している場合、クライアントは合計３回の通信が必要である。
しかしAPIゲートウェイを利用すると、クライアントは１回の通信で済むという。クライアントは細かなところを気にする必要ない。APIゲートウェイ側で全部やってくれる。
APIゲートウェイとは"技術"というよりも"サービス"と呼んだほうがふさわしい。技術用語でなくビジネス用語の部類なのだろう。<br>
決済代行である場合、APIを指してゲートウェイ方式と読んでいるところもあるようだ。それに対になる言葉はおそらくリンク方式なのかもしれない。<br>
<br>

API Gatewayで検索すると「Amazon API Gateway」が検索結果に多くあらわれる。またREST APIというワードも見かける。<br>
REST API、つまりCORSの技術を利用しているのだろう。となるとトークン、秘密キー、公開キーなどとも関係があるのだろうな。<br>
AmazonのAWSは"s3"など、それっぽいサービスをたくさん提供している印象がある。使ったことはないが。<br>
結論としてシステムエンジニアからすれば、API GatewayはただのAPIに１つにすぎないということだ。たぶんだけど。<br>
<br>

<p>決済代行サービス会社は多い</p>
しかし、「決済代行サービス」というワードで検索すると広告サイトの多いこと。
これは競争の激しいサービスであることを物語っている。
どこの決済代行サービスをつかうか比較しなければならないということだ。
お金がらみなので信用が第一だ。バックにいる企業の知名度は重要になるだろう。<br>
<br>

<p>決済代行サービスの技術的な仕組み</p>
どこでもいいので、決済代行サービスの技術的な導入方法を知りたい。
「決済代行サービス JavaScript」でググる。
それでも広告が多いが、ゼウスという決済サービスサイトに技術的情報が書かれていた。(なお、私はゼウスなる会社のまわしものにあらず。たまたま見つけただけ)<br>
サイトを見回すと以下の情報を見つけた。<br>
<pre>
	事業者側サイトにて決済情報（カード番号、有効期限など）を入力いただき、ゼウス提供のJavaScriptプログラムにて決済処理
	指定URLに必要情報（パラメータ）を送信
	受注システム連携：レスポンス取得、CGI送信
	メールによる決済結果通知
	レスポンス取得
	CGI送信による結果パラメータ受信
</pre>
CGIという言葉を久しぶりに聞いた。CORSやCURLでパラメータ送信ということだろう。<br>
パラメータはカード番号とその有効期限である。<br>
メールによる決済通知とあるがこれは多分クライアントへのメール通知であり、一般客へメールするわけではないのかもしれない。
一般客へは、クライアント側でメール通知しないといけないのかもしれない。
レスポンスは決済成功かどうかの情報であることが推測される。<br>
当たり前であるが一般客情報はクライアント側のシステムで管理しないといけない。
しかしカード番号や有効期限をデータベースで管理する必要はないだろう。
こういう大切な情報は保持するだけでリスクである。お金を払ったかどうか、これだけをデータベースで管理すればよいだろう。<br>
言葉選びが開発者向きだ。ゼウスの開発者には親近感がもてる。<br>
一応、クレジットカード支払いだけの対応なのかな。クレジットカード以外の支払いも可能なのだろうか。<br>
<br>

他の決済代行サービスの情報も見てみる。
大手のGMOを調べてみよう。<br>
テスト環境などもあるらしいが技術の資料請求せよとのこと。まあ、予想はつくので資料までは見る必要もあるまい。<br>
支払い方法はクレジットカード以外にもたくさんあるようだ。<br>
接続方式つまり情報のやり取り方法はリンクタイプPlus,リンクタイプ、モジュールタイプ、プロトコルタイプがある。<br>
<br>
リンクタイプ系はURLにパラメータをセットする方式かな。支払いのレスポンスはどのようになっているのだろうか。<br>
<br>
モジュールタイプ、これはPHPのモジュールのことを指しているのかもしれない。PHPモジュールの方法はパラメータにもよるが難しそうに見えて意外と簡単だ。<br>
<br>
プロトコルタイプ、これは通信プロトコルのことを指しているのかもしれない。HTTPSプロトコルならRESTとCORSだろう。
SSHプロトコルもありうる。使わないけど。<br>
<br>
結論としては考えることが多い。つまり開発者の作業量が増えるということだ。GMO決済サービスを利用するなら見積もり工数を多めにしようかな。<br>
<br>

<p>サブスクリプションについて考える</p>
さて、今回の案件依頼はサブスクリプション、いわゆるサブスクだ。
サブスクは2021年からおおいに流行っている。
しかし、私はサブスクが嫌いであまり利用していない。利用しているのはGoogle Driveの容量増加サービスくらい(月額250円）。<br>
まあ、ここで重要なのは解約するまで自動的にお金を定期的に支払い続ける仕組みになっているということだ。
普通の決済代行サービスでは一回限りの支払いだが、サブスクは毎月あるいは毎年と定期的に自動支払いをする。
取引の仕方が違う。つまり決済サービスもサブスクに対応したサービス会社を探さねばならないというとうことだ。<br>
技術的にも1回支払いのパラメータとは異なるだろうし、毎月、毎年の支払いチェックも必要になってくるのかもしれない。うーん想像するだけで頭がいたい。<br>
<br>

<p>サブスク決済に対応する会社について</p>
「ROBOT PAYMENT」とかいう会社が出てきた。
顧客データベースなんかも用意しているらしい。しかし、サイト情報だけでは詳しい技術が不明。
説明がアバウトすぎてよく分からない。<br>
詳細は資料請求しないといけないようだ。作業を増えそうなので次の会社を探そう。<br>
<br>
上記にもでてきたゼウスがまた出てきた。サブスクリプション決済にも対応しているらしい。なかなか優秀だなこの会社。
以下の２種類の方法があるようだ。
<ul>
	<li><a href="https://www.cardservice.co.jp/point/flexible_01.html" target="_blank">売上管理画面による継続課金（定期課金）システム</a></li>
	<li><a href="https://www.cardservice.co.jp/point/flexible_02.html">API連携・バッチ処理での継続課金（定期課金）システム</a></li>
</ul>
<br>

<p>ゼウスの売上管理画面による継続課金（定期課金）システム</p><br>
システムへの組み込みが容易になることが想像できる。問題は自動支払いかどうかだ。一般客が毎月手動で支払いというものでは意味がない。<br>
<br>
気になる情報が。
<pre>
A.  API連携で毎月自動で決済をあげることはできますか？

Q. 
いいえ、毎月請求データを登録する必要がございます。
毎月、事業者様にて”追加”で決済をあげていただく仕様の継続的な決済となります。
月2回の請求や、隔月での請求など、事業者様の運用に合わせてご利用いただけます。
もし毎月自動での決済をご希望場合は、定期購入機能に対応したショッピングカートや毎月自動的にバッチ処理を行う仕組みを構築いただくことで、対応が可能となります。
</pre>
どうしようこれ。一般客が支払い手続きするのでなく、クライアント側の担当者が毎月請求手続きをするということになっている。<br>
手動なので担当者の目でしっかりと確認できるというメリットもある。
というか実際の運用ではお金の流れを担当者が管理しておく必要もあるだろう。<br>
<br>
クライアントのサービスシステムに組み込む場合を考えて見る。<br>
クライアントの担当者が手動でゼウスの売上管理画面で一般客の支払い状況を確認し、
支払いがなされていたらその客のサービスシステム利用を継続、支払いされないのであれば担当者は手動で利用停止するという流れになるのだろう。<br>
<br>
運用はシンプルになるので開発コストは安くすむ。目視でお金をチェックできるのも良い。しかし、担当者の仕事が増えるのはデメリットであろう。<br>
とはいえCSVに対応している。CSVファイルで一括作業も可能、つまり担当者の工夫次第で時短できるということだ。
これならクライアントの負担も軽減できる。すばらしい。この方法は第一候補だな。
<br>
問題点<br>
テスト環境を用意するのがたいへんんそうだ。自分のクレジットカードやデビッドカードでなんとかするしかないか。いろいろ考えないと。<br>
クライアント向けのテスト環境も必要だろう。<br>
クレジットカード番号変更もできるととはあるが、この辺も気になるところだ。<br>
<br>

<p>ゼウスのAPI連携・バッチ処理での継続課金（定期課金）システム</p>
バッチ処理を行うとのこと。バッチ処理はゼウス側で行うのだろうか？<br>
そうみたいだ。クレジットカード情報はゼウス側で保持管理してくれるというので安心。<br>
<br>
初回決済と継続決済に分けて考えられている。
初回決済は、まあ初回のクレジットカードとかだな。そう難しくはあるまい。リンク型、トークン型(JavaScript)、API型、メールリンク型などいろいろなパターンが用意されている。<br>
<br>
継続決済はクライアントのデータベース、ゼウスデータベース、クレジットカード会社の３つのデータベース間で処理が行われているようだ。
開発者からしてみればクライアントのデータベースとゼウスデータベースだけを考えればよい。
ゼウスデータベースでは会員ＩＤがユニークＩＤとして扱われている。クライアントデータベースでもゼウス会員ＩＤなるものを用意すべきだな。
クライアントのシステムから請求データをゼウスのシステムに送らねばならないようだ。請求データ送る方法は何だろうか。送信データ件数にも制限とかありそうだ。
図解を見る限り決済結果はクレジットカード会社から送られてくるように見える。これはちょっと問題だ。クレジットカード会社とのやりとりまでは考えたくない。<br>
<br>
<p>資料を見る</p>
資料請求するとしばらくて資料サイトへの案内メールが届いた。
PDF資料か。ビジネス的なことが書いてあり、技術的な事柄は書かれていない。
サブスクの場合、クライアント側の審査が必要のようだ。<br>
<br>

<p>調査の終わりに</p>
クライアントにはゼウスを紹介しようかな。
ビジネスには疎いのでよく分からないが、ゼウスのバックにはソフトバンクがいるような感じだし信頼性も高かろう。<br>
料金形態が複雑なので私のほうから説明することは不可能であることも伝えるべきだろう。あと審査もあることも伝えよう。<br>
さて今回、依頼案件、受注できるかなー。余裕はあるので無理して受注することもない。<br>
<br>


<br>
<p>おまけ Paypal</p>
Paypalも知名度があるので調べてみることにした。しかし、開発者向けのサイトがセキュリティソフトにより警告される。
何が起きている？<br>
古い記事だが参考サイトもあった。サブスクのではなさげだけど。→
<a href="https://qiita.com/PPJP/items/db5c57991c2c3fe80ac7">PayPal 決済の実装方法</a><br>
<br>
<br>
<br>


<h2>導入</h2>
技術資料
<a href="https://www.cardservice.co.jp/guide/set.html">https://www.cardservice.co.jp/guide/set.html</a><br>
<a href="https://www.cardservice.co.jp/zmc/manual/system.html">https://www.cardservice.co.jp/zmc/manual/system.html</a><br>
<br>







<div class="yohaku"></div>
<ol class="breadcrumb">
	<li><a href="/">ホーム</a></li>
	<li><a href="/note_prg">プログラミングの覚書</a></li>
	<li><a href="/note_prg/js/">JavaScriptの覚書</a></li>
	<li>決済代行サービスについて</li>
</ol>

</div><!-- content -->
<div id="footer">(C) amaraimusi 2022-5-17</div>
</body>
</html>