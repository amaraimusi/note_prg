<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="google" content="notranslate" />
   	<meta http-equiv="X-UA-Compatible" content="IE=edge">
   	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQLの覚書 | ワクガンス</title>
	<link rel='shortcut icon' href='/home/images/favicon.ico' />
	
	<link href="/note_prg/css/jquery-ui.min.css" rel="stylesheet">
	<link href="/note_prg/css/bootstrap.min.css" rel="stylesheet">
	<link href="/note_prg/css/highlight/default.css" rel="stylesheet">
	<link href="/note_prg/css/common2.css" rel="stylesheet">

	<script src="/note_prg/js/jquery3.js"></script>	<!-- jquery-3.3.1.min.js -->
	<script src="/note_prg/js/jquery-ui.min.js"></script>
	<script src="/note_prg/js/bootstrap.min.js"></script>
	<script src="/note_prg/js/highlight.pack.js"></script>
	<script src="/note_prg/js/livipage.js"></script>
	<script src="/note_prg/js/ImgCompactK.js"></script>

	<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<div id="header" ><h1>MySQLの覚書 | ワクガンス</h1></div>
<div class="container">



<div id="sec8-1" class="sec4">
	<h3>INSERTしたレコードのidを取得（AUTO_INCREMENT 型のidである場合） | LAST_INSERT_ID()</h3>
	
	INSERTの実行直後に下記を実行すること。<br>
	また、トランザクションの中で実行すること。<br>
	<pre><code>SELECT LAST_INSERT_ID()</code></pre>

	<br><time>2019-1-11</time>
</div>



<div id="sec8-2" class="sec4">
	<h3>緯度経度フィールドを含むサンプルデータを100万件作成</h3>
	
	<table class="tbl2">
		<thead>
			<tr><th>フィールド</th><th>型</th></tr>
		</thead>
		<tbody>
			<tr><td>id</td><td>int(主キー auto)</td></tr>
			<tr><td>big_name</td><td>varchar(64)</td></tr>
			<tr><td>lat</td><td>double</td></tr>
			<tr><td>lng</td><td>double</td></tr>
		</tbody>
	</table><br>
	
	100万件分の行を作成する。(二の二十乗=104万...)<br>
	<pre><code>
	INSERT INTO bigs () VALUES ();
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	INSERT INTO bigs (id) SELECT 0 FROM bigs;
	</code></pre><br>
	
	一括サンプルデータ入力
	<pre><code>
	UPDATE bigs SET
	  big_name = CONCAT('ビッグマン', id),
	  lat =RAND() * 180 - 90,
	  lng =RAND() * 360 - 180
	</code></pre>
	<aside>
		lat(緯度)は-90～90の範囲でランダム。<br>
		lng(経度)は-180～180の範囲でランダム。<br>
	</aside><br>
	
	
	<a href="https://qiita.com/tayasu/items/c5ddfc481d6b7cd8866d" target="blank">参考サイト</a><br>
	<br>

	<br><time>2019-8-19</time>
</div>



<div id="sec8-3" class="sec4">
	<h3>緯度経度による検索を早くするためのチューニング</h3>
	
	以下のチューニングを行うと緯度経度による検索(SELECT)は速くなるが挿入、更新、削除は遅くなる。<br>
	<br>
	
	<table class="tbl2">
		<thead>
			<tr><th>フィールド</th><th>型</th></tr>
		</thead>
		<tbody>
			<tr><td>id</td><td>int(主キー)</td></tr>
			<tr><td>big_name</td><td>varchar(64)</td></tr>
			<tr><td>lat</td><td>double(8,6)</td></tr>
			<tr><td>lng</td><td>double(9,6)</td></tr>
		</tbody>
	</table>
	まず緯度経度の桁数を制限。<br>
		lat(緯度)の型は「double(8,6)」すなわち桁数8,小数点以下の桁数6にする。<br>
		lng(経度)の型は「double(9,6)」、すなわち桁数9,小数点以下の桁数6にする。<br>
		<aside>桁数を上記のように短く制限することにより1m以内の誤差が生じる。</aside>
		<br>
		
		latとlngにインデックスを追加。
		<pre><code>
		ALTER TABLE bigs ADD INDEX lat_index(lat);
		ALTER TABLE bigs ADD INDEX lng_index(lng);
		</code></pre>
		
		以上でチューニング完了。<br>
		<br>
		
		<p>検証結果について</p>
		100万件データで下記の検索SQLを実行したときの計測時間を測定。
		<pre>SELECT big_name, lat, lng from bigs where lat &gt; 26 AND lat &lt; 27 AND lng &gt; 127 AND lng &lt; 128</pre>
		計測時間<br>
		チューニング前→ クエリの実行時間： 1.2658 秒<br>
		チューニング後→ クエリの実行時間： 0.5152 秒<br>
		<br>
		
		倍以上の改善が見られた。<br>
		<br>

	<br><time>2019-8-19</time>
</div>



<div id="sec8-4" class="sec4">
	<h3>Alterで列の変更や追加ができない | #1067-'post_date' | sql_mode</h3>
	
	datetime型のフィールドでデフォルト値に「0000-00-00 00:00:00」が入っているとAlterによる列編集でエラーが起きるようになる。<br>
	<br>
	
	<p>対策</p>
	my.iniを開き、sql_modeを書き換える。
	<pre>
	#sql_mode=NO_ZERO_IN_DATE,NO_ZERO_DATE,NO_ENGINE_SUBSTITUTION
	sql_mode=ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
	</pre>
	
	<aside>
	my.iniの場所（xamppの場合）<br>
	C:\xampp\mysql\bin\my.ini
	</aside>


	<br><time>2019-10-21</time>
</div>



<div id="sec8-0" class="sec4" style="display:none">
	<h3>xxx</h3>


	<br><time>2019-1-11</time>
</div>



<div class="yohaku"></div>
<ol class="breadcrumb">
	<li><a href="/">ホーム</a></li>
	<li><a href="/note_prg">プログラミングの覚書</a></li>
	<li><a href="/note_prg/mysql/">MySQLの覚書</a></li>
</ol>
</div><!-- content -->
<div id="footer">(C) kenji uehara 2019-1-11</div>
</body>
</html>